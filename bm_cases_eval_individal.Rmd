---
title: "AWEAR Case studies analyses"
author: "Julia Thorpe"
date: "September 2018"
output:
  html_document: default
  pdf_document: default
  word_document: default
always_allow_html: yes
---

Some first results from visualising data for all participants.

All of the plots below follow the same format: time along horizontal axis and dates up vertical axis, plotting the entire participation period for each participant. (Note: ignore date at start of all the time axes, which likely show a current or recent date).


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# For solving package install problem: https://stackoverflow.com/questions/5700505/windows-7-update-packages-problem-unable-to-move-temporary-installation
# trace(utils:::unpackPkgZip, edit=TRUE) > line 140 (line 142 in R 3.4.4) > Sys.sleep(0.5) > Sys.sleep(2)

# Load packages and functions.
library(data.table)
library(dtplyr)
library(dplyr)
library(magrittr)
library(lubridate)
library(ggplot2)
library(reshape2)
library(maptools)
library(plotly)
library(maps)
library(mapproj)
library(sp)
library(caTools)
library(geosphere) # added in v3 of data checker
library(mapview) # added in v1 of analysis framework
library(tidyr) # added for function "complete" in assessments section
library(htmltools)
library(RColorBrewer)
library("readxl") # For reading in pilot data

# Load custom functions:
source("./Rscripts/stylesheet.R")
source("./Rscripts/JRT_utils.R")

```

Possibly merge all results from all participants into one dataset to make it easier to plot the various subsets. These should include a row per day per participant with the following columnns:

* all mobility metrics
* ES answers
* metrics derived from acitivity bouts (e.g. still periods, use of bike/foot/vehicle as transport)
* daily stepcount (watch and phone each own column)


```{r data_load, include=FALSE}


p.codes <- c("P03JJ","P06SS","P07MG","P08UH","P10JL","P13NB") # case studies

dist.cutoff <- 50000 # for filtering AR.max to not get holidays 

# # select participant for analysis
# p <- "P10JL"
# 
# # load data for current participant
# p.metrics <- readRDS(paste0("./output_data/metrics_",p,".Rds"))
# p.es <- readRDS(paste0("./output_data/es_",p,".Rds"))

# load complete datasets
source("./Rscripts/cases_data_load.R")

source("./Rscripts/cases_plotter_A2.R")

```


Visualising the data as a first impression
* Distributions for each of the metrics
* Filter and repeat

```{r echo=FALSE}

# MOBILITY
n <- 1
# Spatial
subplot(hist.mob.ar, nrows=n) %>% layout(title="Action range")
subplot(hist.mob.dist, nrows=n) %>% layout(title="Distance covered")
subplot(hist.mob.mcp, nrows=n) %>% layout(title="Minimum convex polygon")

# Spatial - Filtered
subplot(hist.mob.ar.f, nrows=n) %>% layout(title="Action range (filtered)")
subplot(hist.mob.dist.f, nrows=n) %>% layout(title="Distance covered (filtered)")
subplot(hist.mob.mcp.f, nrows=n) %>% layout(title="Minimum convex polygon (filtered)")

# Temporal
subplot(hist.mob.Tmove, nrows=n) %>% layout(title="Time spent moving between places")
subplot(hist.mob.Tout, nrows=n) %>% layout(title="Time spent out of home")

# Counts
subplot(hist.mob.Nplace, nrows=n) %>% layout(title="Number of unique places visited")
subplot(hist.mob.Nmove, nrows=n) %>% layout(title="Number of moves between places")

# ACTIVITY

# steps:
# total steps
subplot(hist.act.steps, nrows=n) %>% layout(title="Daily stepcount") # PROBLEMS! FIXED :)
subplot(hist.act.Tactive, nrows=n) %>% layout(title="Time spent on foot/bike") 
subplot(hist.act.Nactive, nrows=n) %>% layout(title="Number of foot/bike bouts") 
subplot(hist.act.Tstill, nrows=n) %>% layout(title="Time spent still between 6am and 10pm") 

```

Now look at relation between data and ES

* Show ranges of each variable against the answers (could have a plot per metrics including all participants as traces)

TO ADD: ES activity answers and
* step counts, watch/phone (whichever is higher) 
* still periods 


```{r es_metrics_spread}

# mobility answers + metrics:
subplot(range.compare.ar, shareY=TRUE) %>% layout(title="Action Range")
subplot(range.compare.dist, shareY=TRUE) %>% layout(title="Distance covered")
subplot(range.compare.mcp, shareY=TRUE) %>% layout(title="MCP")

subplot(range.compare.Tout, shareY=TRUE) %>% layout(title="Time out of home")
subplot(range.compare.Tmove, shareY=TRUE) %>% layout(title="Time moving")

subplot(range.compare.Nplaces, shareY=TRUE) %>% layout(title="N places")
subplot(range.compare.Nmoves, shareY=TRUE) %>% layout(title="N moves")



# # For single participant
# p.es.mob <- p.es %>% filter(question_id=="jrt_mobility")
# p.compare.mob <- merge(x=p.metrics, y=p.es.mob, by="dates")
# 
# plot_ly(p.compare.mob %>% group_by(answer),
#         x=~AR.max,
#         y=~answer,
#         type = "scatter",
#         mode = "markers+lines") %>%
#   add_trace(x=~dist.total)
# 
# plot_ly(p.compare.mob %>% group_by(answer),
#         x=~Tt.move,
#         y=~answer,
#         type = "scatter",
#         mode = "markers+lines") %>%
#   add_trace(x=~Tt.out)
# 
# plot_ly(p.compare.mob %>% group_by(answer),
#         x=~N.places,
#         y=~answer,
#         type = "scatter",
#         mode = "markers+lines") %>%
#   add_trace(x=~N.moves)


```

Convert the metrics to scores and compare with ES answers directly, include:
* Table showing which is most correlated (should end up demonstrating that a combo is best)
* Spatial, Temporal and Counts (not sure about counts?!)

Could make "distance", "temporal" and "count" scores and one total overall combo

TO ADD: convert activity features to scores, including:
* step counts, watch/phone (whichever is higher) 
* still periods 

Compare with activity scores as per other plots.



```{r scoring}

subplot(met.scores, nrows=6) %>% layout(title="comparison with scores")

# tester<- metrics.mob %>%
#   group_by(participant) %>%
#   do(quantile(.$AR.max, probs = prbs) %>% data.frame() %>% tibble::rownames_to_column("Q")) %>% 
#   rename(AR.max.q = ".")
# 
# test %>% summarise(ar.max.diff = mean(abs(AR.max.score-answer)),
#                    dist.total.diff = mean(abs(dist.total.score-answer)),
#                    mcp.diff = mean(abs(mcp.score-answer)),
#                    Tt.move.diff = mean(abs(Tt.move.score-answer)),
#                    Tt.out.diff = mean(abs(Tt.out.score-answer)),
#                    combo.diff = mean(abs(combo-answer)))



```


Comparison with baseline data:

* mobility zones (LSA)
* activity: transport and still periods (GPAQ)