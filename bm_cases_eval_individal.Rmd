---
title: "AWEAR Case studies analyses"
author: "Julia Thorpe"
date: "September 2018"
output:
  html_document: default
  pdf_document: default
  word_document: default
always_allow_html: yes
---

Some first results from visualising data for all participants.

All of the plots below follow the same format: time along horizontal axis and dates up vertical axis, plotting the entire participation period for each participant. (Note: ignore date at start of all the time axes, which likely show a current or recent date).


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# For solving package install problem: https://stackoverflow.com/questions/5700505/windows-7-update-packages-problem-unable-to-move-temporary-installation
# trace(utils:::unpackPkgZip, edit=TRUE) > line 140 (line 142 in R 3.4.4) > Sys.sleep(0.5) > Sys.sleep(2)

# Load packages and functions.
library(data.table)
library(dtplyr)
library(dplyr)
library(magrittr)
library(lubridate)
library(ggplot2)
library(reshape2)
library(maptools)
library(plotly)
library(maps)
library(mapproj)
library(sp)
library(caTools)
library(geosphere) # added in v3 of data checker
library(mapview) # added in v1 of analysis framework
library(tidyr) # added for function "complete" in assessments section
library(htmltools)
library(RColorBrewer)
library("readxl") # For reading in pilot data

# Load custom functions:
source("./Rscripts/stylesheet.R")
source("./Rscripts/JRT_utils.R")

```

Possibly merge all results from all participants into one dataset to make it easier to plot the various subsets. These should include a row per day per participant with the following columnns:

* all mobility metrics
* ES answers
* metrics derived from acitivity bouts (e.g. still periods, use of bike/foot/vehicle as transport)
* daily stepcount (watch and phone each own column)


```{r data_load, include=FALSE}


p.codes <- c("P03JJ","P06SS","P07MG","P08UH","P10JL","P13NB") # case studies

dist.cutoff <- 50000 # for filtering AR.max to not get holidays 

# # select participant for analysis
# p <- "P10JL"
# 
# # load data for current participant
# p.metrics <- readRDS(paste0("./output_data/metrics_",p,".Rds"))
# p.es <- readRDS(paste0("./output_data/es_",p,".Rds"))

# load complete datasets
source("./Rscripts/cases_data_load.R")

source("./Rscripts/cases_plotter_A2.R")

```


Visualising the data as a first impression
* Distributions for each of the metrics
* Filter and repeat

```{r echo=FALSE}

# MOBILITY
n <- 1
# Spatial
subplot(hist.mob.ar, nrows=n) %>% layout(title="Action range")
subplot(hist.mob.dist, nrows=n) %>% layout(title="Distance covered")
subplot(hist.mob.mcp, nrows=n) %>% layout(title="Minimum convex polygon")

# Spatial - Filtered
subplot(hist.mob.ar.f, nrows=n) %>% layout(title="Action range (filtered)")
subplot(hist.mob.dist.f, nrows=n) %>% layout(title="Distance covered (filtered)")
subplot(hist.mob.mcp.f, nrows=n) %>% layout(title="Minimum convex polygon (filtered)")

# Temporal
subplot(hist.mob.Tmove, nrows=n) %>% layout(title="Time spent moving between places")
subplot(hist.mob.Tout, nrows=n) %>% layout(title="Time spent out of home")

# Counts
subplot(hist.mob.Nplace, nrows=n) %>% layout(title="Number of unique places visited")
subplot(hist.mob.Nmove, nrows=n) %>% layout(title="Number of moves between places")

# ACTIVITY

# steps:
# total steps
subplot(hist.act.steps, nrows=n) %>% layout(title="Daily stepcount") # PROBLEMS! FIXED :)
subplot(hist.act.Tactive, nrows=n) %>% layout(title="Time spent on foot/bike") 
subplot(hist.act.Nactive, nrows=n) %>% layout(title="Number of foot/bike bouts") 
subplot(hist.act.Tstill, nrows=n) %>% layout(title="Time spent still between 6am and 10pm") 

remove(
  hist.act.Nactive,
  hist.act.steps,
  hist.act.Tactive,
  hist.act.Tstill,
  hist.mob.ar,
  hist.mob.ar.f,
  hist.mob.dist,
  hist.mob.dist.f,
  hist.mob.mcp,
  hist.mob.mcp.f,
  hist.mob.Nmove,
  hist.mob.Nplace,
  hist.mob.Tmove,
  hist.mob.Tout
)

```

Now look at relation between data and ES

* Show ranges of each variable against the answers (could have a plot per metrics including all participants as traces)

TO ADD: ES activity answers and
* step counts, watch/phone (whichever is higher) 
* still periods 


```{r es_metrics_spread}

# mobility answers + metrics:
subplot(range.compare.ar, shareY=TRUE) %>% layout(title="Action Range")
subplot(range.compare.dist, shareY=TRUE) %>% layout(title="Distance covered")
subplot(range.compare.mcp, shareY=TRUE) %>% layout(title="MCP")

subplot(range.compare.Tout, shareY=TRUE) %>% layout(title="Time out of home")
subplot(range.compare.Tmove, shareY=TRUE) %>% layout(title="Time moving")

subplot(range.compare.Nplaces, shareY=TRUE) %>% layout(title="N places")
subplot(range.compare.Nmoves, shareY=TRUE) %>% layout(title="N moves")

subplot(range.compare.activeT, shareY=TRUE) %>% layout(title="Active Time")
subplot(range.compare.activeB, shareY=TRUE) %>% layout(title="N active bouts")
subplot(range.compare.still, shareY=TRUE) %>% layout(title="Still periods")
subplot(range.compare.steps, shareY=TRUE) %>% layout(title="Steps")

remove(
  range.compare.ar,
  range.compare.dist,
  range.compare.mcp,
  range.compare.Nmoves,
  range.compare.Nplaces,
  range.compare.Tmove,
  range.compare.Tout,
  range.compare.activeT,
  range.compare.activeB,
  range.compare.still,
  range.compare.steps
)

# # For single participant
# p.es.mob <- p.es %>% filter(question_id=="jrt_mobility")
# p.compare.mob <- merge(x=p.metrics, y=p.es.mob, by="dates")
# 
# plot_ly(p.compare.mob %>% group_by(answer),
#         x=~AR.max,
#         y=~answer,
#         type = "scatter",
#         mode = "markers+lines") %>%
#   add_trace(x=~dist.total)
# 
# plot_ly(p.compare.mob %>% group_by(answer),
#         x=~Tt.move,
#         y=~answer,
#         type = "scatter",
#         mode = "markers+lines") %>%
#   add_trace(x=~Tt.out)
# 
# plot_ly(p.compare.mob %>% group_by(answer),
#         x=~N.places,
#         y=~answer,
#         type = "scatter",
#         mode = "markers+lines") %>%
#   add_trace(x=~N.moves)


```

Convert the metrics to scores and compare with ES answers directly, include:
* Table showing which is most correlated (should end up demonstrating that a combo is best)
* Spatial, Temporal and Counts (not sure about counts?!)

Could make "distance", "temporal" and "count" scores and one total overall combo

TO ADD: convert activity features to scores, including:
* step counts, watch/phone (whichever is higher) 
* still periods 

Compare with activity scores as per other plots.



```{r scoring}

subplot(mob.scores, nrows=6) %>% layout(title="comparison with scores")
subplot(act.scores, nrows=6) %>% layout(title="comparison with scores")

# tester<- metrics.mob %>%
#   group_by(participant) %>%
#   do(quantile(.$AR.max, probs = prbs) %>% data.frame() %>% tibble::rownames_to_column("Q")) %>% 
#   rename(AR.max.q = ".")
# 
# test %>% summarise(ar.max.diff = mean(abs(AR.max.score-answer)),
#                    dist.total.diff = mean(abs(dist.total.score-answer)),
#                    mcp.diff = mean(abs(mcp.score-answer)),
#                    Tt.move.diff = mean(abs(Tt.move.score-answer)),
#                    Tt.out.diff = mean(abs(Tt.out.score-answer)),
#                    combo.diff = mean(abs(combo-answer)))



```


Comparison with baseline data:

* mobility zones (LSA)
* activity: transport and still periods (GPAQ)

```{r compare_assess}
# put the analyses cut from last paper here.

```

### Comparison between perceived and objectively measured individual goal attainment

Participant: P03JJ
Goal: to maintain current schedule of activities, and to travel to them by bicycle (5 per week)

```{r goal_p03}

# discarded



```

Participant: P06SS
Goal: walk longer daily (and train 3 times per week, need to look into the details for this)

```{r goal_p06}

# import participant reported goal attainment
p06.perceived <- c(-1,0,0,1,NA,-1,NA,-1,-1,NA,-1,NA)
p06.calldates <- as.Date(c(
  "23-03-2018", 
  "03-04-2018",
  "10-04-2018",
  "17-04-2018",
  "24-04-2018", NA,
  "01-05-2018",
"08-05-2018",
"17-05-2018",
"23-05-2018",
"04-06-2018", NA), format = "%d-%m-%Y")


# measure from metrics/data
p06.metrics.mob <-
  metrics.mob %>% filter(participant == "P06SS")

p06.metrics.act <-
  merge(
    metrics.act %>% filter(participant == "P06SS"),
    act.pday %>% filter(participant == "P06SS", activity == "Foot"),
    by=c("dates", "participant"),
    all=T
  )

p06.metrics <- merge(p06.metrics.mob,
                     p06.metrics.act,
                     by=c("dates", "participant"),
                     all=T)
remove(p06.metrics.mob,p06.metrics.act)

# adjust the dates to get weeks that match phonecalls (remove days 8-11, then calculate study weeks, which are not continuous calendar weeks)
p06.metrics %<>% filter( day < 8 | day > 11 ) %>%
  mutate(day = c(1:n())) %>%
  mutate(week = ((day-1) %/% 7)+1)

T.foot.pfunc <- ecdf(p06.metrics$total.time)
steps.pfunc <- ecdf(p06.metrics$steps)



# Tabulate results by week
p06.weekly.results <- p06.metrics %>% group_by(week) %>%
  summarise( #Ndays = n(),
             still.time.mean = round(mean(still.time, na.rm = T)), # still periods 
             walk.time.mean = round(mean(total.time, na.rm = T)), # time on foot (might need to replaces NA with 0)
             steps = round(mean(steps, na.rm = T)), # steps
             date = max(dates)) %>%
  mutate(walk.Q = T.foot.pfunc(walk.time.mean) %>% round(2),
         steps.Q = steps.pfunc(steps) %>% round(2)) %>%
  mutate(SR.goal = p06.perceived)

p06.weekly.results[1:11,] %>% select(week,walk.time.mean,steps,walk.Q,steps.Q,SR.goal)

answer_bars <- data.frame(dates = p06.calldates,
                          answer = p06.perceived,
                          zero = 0) %>%
  melt(id.vars = "dates")

plot_ly(p06.metrics,
        x = ~dates,
        y = ~(T.foot.pfunc(total.time)-0.5)*2,
        type = "scatter",
        mode = "markers+lines",
            marker = list(size=2, color = greys[3]),
            line = list(width = 2, color =  greys[3],dash = "dash")) %>%
  add_trace(y = ~(steps.pfunc(steps)-0.5)*2,
            marker = list(size=2, color =  greys[5]),
            line = list(width = 2, color =  greys[5],dash = "dot")) %>%
  add_trace(data = answer_bars %>% arrange(dates) %>% group_by(dates),
            x = ~dates,
            y = ~value,
            marker = list(size=10, color = "red"),
            line = list(width = 6, color = "red",dash="none"))


plot_ly(p06.weekly.results,
        x = ~week,
        y = ~SR.goal,
        type = "scatter",
        mode = "markers",
        marker = list(size=12, color = "red"),
        name = "Reported score") %>%
  add_bars(y = ~SR.goal, width=0.1, showlegend = FALSE) %>%
  add_trace(y = ~(steps.Q-0.5)*2,
            mode = "markers+lines",
            marker = list(size=2, color =  greys[5]),
            line = list(width = 2, color =  greys[5],dash = "dot"),
            name = "Steps") %>%
  add_trace(y = ~(walk.Q-0.5)*2,
            mode = "markers+lines",
            marker = list(size=2, color = greys[3]),
            line = list(width = 2, color =  greys[3],dash = "dash"),
            name = "Walk time")

# ,
#         line = list(width = 6, color = "red",dash="none")

```

Participant: P07MG
Goal: to get out of the house every day

```{r goal_p07}

# import participant reported goal attainment
p07.perceived <- c(1,0,0,1,0,-1,1,1)

# measure from metrics/data
p07.metrics.mob <- 
  metrics.mob %>% filter(participant == "P07MG") %>%
  #mutate(day = ifelse(day<8,day,day-4)) %>%
  mutate(week = ((day-1) %/% 7)+1)


p07.metrics.act <- 
  metrics.act %>% filter(participant == "P07MG") %>%
  mutate(day = p07.metrics.mob$day,
         week = p07.metrics.mob$week)

# plot_ly(metrics.mob.p07,
#         x = ~dates,
#         y = ~N.moves,
#         color = ~as.factor(week),
#         type = "scatter",
#         mode = "markers+lines")


# Tabulate results by week
p07.tab.mob <- p07.metrics.mob %>% group_by(week) %>%
  summarise( Ndays = n(),
             move.days = sum(N.moves > 0),
             T.move.ave = round(mean(Tt.move*60)),
             date = max(dates)) %>%
  mutate(SR.goal = c(p07.perceived,NA))

p07.tab.act <- p07.metrics.act %>% group_by(week) %>%
  summarise( Ndays = n(),
             T.active.ave = round(mean(active.time)),
             steps = round(mean(steps)))

p07.weekly.results <- cbind(p07.tab.mob[1:8,], p07.tab.act[1:8,3:4]) %>% 
  select(week, move.days,T.move.ave,T.active.ave,SR.goal)

p07.weekly.results

plot_ly(p07.weekly.results,
        x = ~week,
        y = ~SR.goal,
        type = "scatter",
        mode = "lines+markers") %>%
  add_trace(y = ~move.days/7) %>%
  add_trace(y = ~T.move.ave/60) %>%
  add_trace(y = ~T.active.ave/60)

remove(p07.metrics.mob, p07.metrics.act, p07.tab.act, p07.tab.mob, p07.weekly.results, p07.perceived)

```

Participant: P08UH
Goal: to drive less and ride bike more, at least 4 days per week

```{r goal_p08}
# perceived goal attainment
p08.perceived <- c(-1,-1,0,NA,-1,0,0,0)


# get all recorded dates/days for participant
p08.metrics <- metrics.mob %>% filter(participant == "P08UH") %>%
  select(participant, dates, day) %>% 
  mutate(day = day-7) %>% # to match dates of weekly calls
  filter(day > 0)

p08.bike <- act.pday %>% filter(participant == "P08UH", activity == "Bicycle")
p08.vehicle <- act.pday %>% filter(participant == "P08UH", activity == "Vehicle")
p08.trans <- merge(x = p08.bike, y = p08.vehicle, by=c("participant","dates"), all=TRUE, suffixes=c(".bike",".vehicle")); remove(p08.bike, p08.vehicle)

p08.goals <- 
  merge(p08.metrics, p08.trans, by=c("participant","dates"), all.x=TRUE) %>%
  select(dates, day, total.time.bike, N.bike, total.time.vehicle, N.vehicle) %>%
  mutate(week = ((day-1) %/% 7)+1)
#remove(p08.metrics,p08.trans)

p08.goals[is.na(p08.goals)] <- 0

p08.weekly.results <- p08.goals %>% filter(week < 9) %>%
  group_by(week) %>%
  summarise(dates = max(dates),
            Ndays = n(),
            bike.days = sum(N.bike>0),
            vehicle.days = sum(N.vehicle>0),
            bike.time = sum(total.time.bike)/sum(N.bike>0),
            vehicle.time = sum(total.time.vehicle)/sum(N.vehicle>0)) %>%
  mutate(SR.goal = p08.perceived)

p08.weekly.results


```

Participant: P10JL
Goal: activity schedule

```{r goal_p10}

# Monday-Friday 1 hour at the training place.

# get the stays, test if they are close to X and duration.
p10.traj.summary <- readRDS("./output_data/traj_goal_P10JL.Rds")
training.loc <- c(12.444629, 55.627071) # lon, lat
  
proximity <- distGeo(p10.traj.summary %>% select(clon,clat),
        training.loc,
        a=6378137, f=1/298.257223563)
p10.traj.summary %<>%
  mutate(prox = proximity) %>%
  mutate(is.training = prox < 150) #threshold within which a stay is considered at the training centre

p10.training.days <- p10.traj.summary %>% group_by(dates) %>%
  summarise(
    training = sum(is.training, na.rm = TRUE),
    training.time = sum(durations[is.training],na.rm = TRUE)
  ) %>%
  mutate(weekday = weekdays(dates))

remove(proximity, training.loc)

# # Examine data to determine threshold
# plot_ly(p10.traj.summary,
#         x = ~T.start,
#         y = ~proximity)


# Get dates and perceived goals;19-03-2018
26-03-2018
03-04-2018
10-04-2018
17-04-2018
24-04-2018
02-05-2018
08-05-2018
15-05-2018
22-05-2018
29-05-2018




```

Participant: P13NB
Goal: get out once per day

```{r goal_p13}

# import participant reported goal attainment
p13.perceived <- c(0,1,0,1,0,0,0,0)


# measure from metrics/data
p13.metrics.mob <-
  metrics.mob %>% filter(participant == "P13NB") %>%
  mutate(week = ((day-1) %/% 7)+1)
 
p13.metrics.act <-
  metrics.act %>% filter(participant == "P13NB")

p13.metrics <- merge(p13.metrics.mob,
                     p13.metrics.act,
                     by=c("dates", "participant"),
                     all=T)

T.move.pfunc <- ecdf(p13.metrics$Tt.move)
steps.pfunc <- ecdf(p13.metrics$steps)



# Tabulate results by week
p13.weekly.results <- p13.metrics %>% group_by(week) %>%
  summarise( Ndays = n(),
             move.days = sum(N.moves > 0),
             T.move.ave = round(mean(Tt.move*60)),
             T.active.ave = round(mean(active.time)),
             steps = round(mean(steps)),
             date = max(dates)) %>%
  mutate(SR.goal = c(p13.perceived,NA),
         steps.prb = steps.pfunc(steps),
         T.move.prb = T.move.pfunc(T.move.ave/60))

p13.weekly.results[1:8,] %>% select(week, move.days,T.move.ave,T.move.prb,T.active.ave,steps,steps.prb,SR.goal)

plot_ly(p13.weekly.results[1:8,],
        x = ~week,
        y = ~SR.goal,
        type = "scatter",
        mode = "lines+markers") %>%
  add_trace(y = ~move.days/7, name = "days with >0 moves") %>%
  add_trace(y = ~T.move.ave/60, name = "ave move time, hrs") %>%
  add_trace(y = ~T.active.ave/60, name = "ave active time, hrs") %>%
  add_trace(y = ~steps/10000, name = "steps in 10k")

plot_ly(p13.weekly.results[1:8,],
        x = ~week,
        y = ~(SR.goal+2)/4,
        type = "scatter",
        mode = "lines+markers") %>%
  add_trace(y = ~move.days/7, name = "days with >0 moves") %>%
  add_trace(y = ~T.move.prb, name = "ave move time") %>%
  add_trace(y = ~steps.prb, name = "steps")


remove(p13.metrics, p13.weekly.results, T.move.pfunc, steps.pfunc, p13.perceived)


```

